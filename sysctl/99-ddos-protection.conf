# =============================================================================
# AIDN - Kernel Hardening for DDoS Protection
# =============================================================================
# Copy to: /etc/sysctl.d/99-ddos-protection.conf
# Apply with: sudo sysctl -p /etc/sysctl.d/99-ddos-protection.conf
# =============================================================================

# -----------------------------------------------------------------------------
# TCP SYN Flood Protection
# -----------------------------------------------------------------------------
# Enable SYN cookies - critical for SYN flood protection
net.ipv4.tcp_syncookies = 1

# Maximum number of remembered connection requests (SYN_RECV state)
# Increase for high-traffic game servers
net.ipv4.tcp_max_syn_backlog = 65536

# Number of times SYNACKs for passive TCP connection attempts are retried
net.ipv4.tcp_synack_retries = 2

# Number of times initial SYNs for an active TCP connection are retried
net.ipv4.tcp_syn_retries = 2

# -----------------------------------------------------------------------------
# Connection Tracking (conntrack) Tuning
# -----------------------------------------------------------------------------
# Maximum number of connections to track (important for high-traffic servers)
net.netfilter.nf_conntrack_max = 1048576

# Hash table size for connection tracking
net.netfilter.nf_conntrack_buckets = 262144

# Timeout for established connections (seconds)
net.netfilter.nf_conntrack_tcp_timeout_established = 432000

# Timeout for connections in FIN_WAIT state
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 30

# Timeout for connections in TIME_WAIT state
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30

# Timeout for connections in CLOSE_WAIT state
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 15

# Timeout for connections in LAST_ACK state
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 15

# UDP connection tracking timeout (important for game servers)
net.netfilter.nf_conntrack_udp_timeout = 30
net.netfilter.nf_conntrack_udp_timeout_stream = 60

# -----------------------------------------------------------------------------
# TCP Stack Hardening
# -----------------------------------------------------------------------------
# Don't accept source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Ignore ICMP redirects (prevent MITM attacks)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Don't send ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Enable reverse path filtering (anti-spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log martian packets (packets with impossible addresses)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Ignore ICMP echo requests to broadcast addresses (Smurf attack protection)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Rate limit ICMP responses
net.ipv4.icmp_ratelimit = 100

# -----------------------------------------------------------------------------
# TCP Performance Tuning for High Traffic
# -----------------------------------------------------------------------------
# Maximum socket receive buffer size
net.core.rmem_max = 16777216

# Maximum socket send buffer size
net.core.wmem_max = 16777216

# Default socket receive buffer size
net.core.rmem_default = 262144

# Default socket send buffer size
net.core.wmem_default = 262144

# TCP memory settings (min, pressure, max) in pages
net.ipv4.tcp_mem = 786432 1048576 1572864

# TCP receive buffer (min, default, max) in bytes
net.ipv4.tcp_rmem = 4096 262144 16777216

# TCP send buffer (min, default, max) in bytes
net.ipv4.tcp_wmem = 4096 262144 16777216

# Maximum number of packets queued on input
net.core.netdev_max_backlog = 65536

# Maximum number of sockets in TIME_WAIT state
net.ipv4.tcp_max_tw_buckets = 1440000

# Enable TCP window scaling
net.ipv4.tcp_window_scaling = 1

# Enable timestamps for better RTT estimation
net.ipv4.tcp_timestamps = 1

# Enable selective acknowledgments
net.ipv4.tcp_sack = 1

# Enable Forward Acknowledgment (FACK)
net.ipv4.tcp_fack = 1

# Faster recovery from losses
net.ipv4.tcp_early_retrans = 3

# -----------------------------------------------------------------------------
# UDP Buffer Tuning (Critical for Game Servers)
# -----------------------------------------------------------------------------
# UDP memory settings (min, pressure, max) in pages
net.ipv4.udp_mem = 786432 1048576 1572864

# UDP receive buffer max
net.ipv4.udp_rmem_min = 16384

# UDP send buffer max
net.ipv4.udp_wmem_min = 16384

# -----------------------------------------------------------------------------
# Connection Queue Sizes
# -----------------------------------------------------------------------------
# Maximum number of connections that can be queued for acceptance
net.core.somaxconn = 65535

# Orphan socket cleanup
net.ipv4.tcp_max_orphans = 262144

# TIME_WAIT socket reuse (helps under load)
net.ipv4.tcp_tw_reuse = 1

# Reduce TIME_WAIT duration (be careful with this in some environments)
# net.ipv4.tcp_fin_timeout = 15

# -----------------------------------------------------------------------------
# IPv6 Hardening (if IPv6 is enabled)
# -----------------------------------------------------------------------------
# Disable IPv6 if not needed (reduces attack surface)
# net.ipv6.conf.all.disable_ipv6 = 1
# net.ipv6.conf.default.disable_ipv6 = 1

# If IPv6 is enabled, harden it
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# -----------------------------------------------------------------------------
# Kernel Security
# -----------------------------------------------------------------------------
# Restrict dmesg access
kernel.dmesg_restrict = 1

# Hide kernel pointers from unprivileged users
kernel.kptr_restrict = 2

# Restrict ptrace scope
kernel.yama.ptrace_scope = 1

# Prevent core dumps of setuid programs
fs.suid_dumpable = 0

# Enable address space layout randomization (ASLR)
kernel.randomize_va_space = 2

# -----------------------------------------------------------------------------
# File Descriptor Limits
# -----------------------------------------------------------------------------
# Maximum number of file descriptors
fs.file-max = 2097152

# Maximum number of inotify watches
fs.inotify.max_user_watches = 524288
