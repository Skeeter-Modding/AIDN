#!/usr/sbin/nft -f
# =============================================================================
# AIDN - DDoS Protection Rules for Game Servers (nftables version)
# =============================================================================
# Modern replacement for iptables - better performance under high load
# Install: sudo cp nftables-ddos.conf /etc/nftables.conf && sudo systemctl enable nftables
# =============================================================================

# Clear existing rules
flush ruleset

# -----------------------------------------------------------------------------
# Configuration variables
# -----------------------------------------------------------------------------
define GAME_PORT = 2001
define STEAM_QUERY_PORT = 17777
define RCON_PORT = 19999
define SSH_PORT = 22
define WAN_IF = "eth0"

# Whitelist IPs (add your admin IPs here)
define WHITELIST = { }

# Private/bogon networks to block on WAN
define BOGONS = {
    10.0.0.0/8,
    172.16.0.0/12,
    192.168.0.0/16,
    224.0.0.0/4,
    240.0.0.0/5,
    127.0.0.0/8,
    0.0.0.0/8
}

# =============================================================================
# Main table
# =============================================================================
table inet filter {

    # -------------------------------------------------------------------------
    # Rate limiting sets
    # -------------------------------------------------------------------------

    # Track SYN flood
    set syn_meter {
        type ipv4_addr
        flags dynamic,timeout
        timeout 10s
    }

    # Track UDP flood per IP
    set udp_meter {
        type ipv4_addr
        flags dynamic,timeout
        timeout 10s
    }

    # Track game connections per IP
    set game_meter {
        type ipv4_addr
        flags dynamic,timeout
        timeout 30s
    }

    # Track query flood
    set query_meter {
        type ipv4_addr
        flags dynamic,timeout
        timeout 10s
    }

    # Track SSH attempts
    set ssh_meter {
        type ipv4_addr
        flags dynamic,timeout
        timeout 60s
    }

    # Port scanners blacklist
    set port_scanners {
        type ipv4_addr
        flags dynamic,timeout
        timeout 86400s
    }

    # -------------------------------------------------------------------------
    # Input chain
    # -------------------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback - always allow
        iif "lo" accept

        # Established/related connections - fast path
        ct state established,related accept

        # Drop invalid
        ct state invalid drop

        # Whitelist IPs (bypass filtering)
        # ip saddr $WHITELIST accept

        # Docker networks
        iif "docker0" accept
        iifname "br-*" accept

        # Jump to protection chains
        jump ddos_protection
        jump game_server
        jump services

        # Log and drop everything else
        # Uncomment for debugging:
        # limit rate 5/minute log prefix "NFT_DROP: " level warn
        drop
    }

    # -------------------------------------------------------------------------
    # DDoS Protection chain
    # -------------------------------------------------------------------------
    chain ddos_protection {
        # Drop bogon/spoofed IPs on WAN interface
        iifname $WAN_IF ip saddr $BOGONS drop

        # Drop fragments
        ip frag-off & 0x1fff != 0 drop

        # Drop invalid TCP flag combinations
        tcp flags & (fin|syn) == (fin|syn) drop
        tcp flags & (syn|rst) == (syn|rst) drop
        tcp flags & (fin|rst) == (fin|rst) drop
        tcp flags & (fin|psh|ack) == (fin|psh) drop
        tcp flags & (ack|urg) == urg drop
        tcp flags == 0x0 drop
        tcp flags == (fin|syn|rst|psh|ack|urg) drop

        # SYN flood protection
        tcp flags syn limit rate over 50/second burst 100 packets drop

        # ICMP flood protection
        ip protocol icmp icmp type echo-request limit rate 10/second burst 20 packets accept
        ip protocol icmp icmp type echo-request drop
        ip protocol icmp icmp type { echo-reply, destination-unreachable, time-exceeded } accept

        # Port scan detection - add to blacklist
        ip saddr @port_scanners drop
        tcp flags syn tcp dport != { $SSH_PORT, $RCON_PORT } \
            ct state new \
            limit rate over 20/second \
            add @port_scanners { ip saddr }
    }

    # -------------------------------------------------------------------------
    # Game Server chain (Arma Reforger)
    # -------------------------------------------------------------------------
    chain game_server {
        # Main game port (UDP) - rate limit per IP
        udp dport $GAME_PORT \
            meter game_limit { ip saddr limit rate over 50/second burst 100 packets } \
            drop
        udp dport $GAME_PORT accept

        # Steam query port (UDP) - stricter rate limit
        udp dport $STEAM_QUERY_PORT \
            meter query_limit { ip saddr limit rate over 10/second burst 20 packets } \
            drop
        udp dport $STEAM_QUERY_PORT accept

        # RCON port (TCP) - very restrictive
        tcp dport $RCON_PORT ct state new \
            meter rcon_limit { ip saddr limit rate over 5/second burst 10 packets } \
            drop
        tcp dport $RCON_PORT ct state new \
            ct count over 3 \
            drop
        tcp dport $RCON_PORT accept
    }

    # -------------------------------------------------------------------------
    # Services chain
    # -------------------------------------------------------------------------
    chain services {
        # SSH - rate limited
        tcp dport $SSH_PORT ct state new \
            meter ssh_limit { ip saddr limit rate over 3/minute burst 5 packets } \
            drop
        tcp dport $SSH_PORT accept
    }

    # -------------------------------------------------------------------------
    # Forward chain (for Docker)
    # -------------------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy accept;

        # Allow Docker traffic
        iifname "docker0" accept
        oifname "docker0" accept
        iifname "br-*" accept
        oifname "br-*" accept
    }

    # -------------------------------------------------------------------------
    # Output chain
    # -------------------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# =============================================================================
# NAT table (for Docker compatibility)
# =============================================================================
table ip nat {
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
    }

    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;
        # Docker masquerade is handled by Docker daemon
    }
}
