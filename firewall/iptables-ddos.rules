#!/bin/bash
# =============================================================================
# AIDN - DDoS Protection Rules for Game Servers (Arma Reforger)
# =============================================================================
# This script configures iptables rules for DDoS mitigation
# Run as root: sudo bash iptables-ddos.rules
# =============================================================================

set -e

# -----------------------------------------------------------------------------
# Configuration - Adjust these for your setup
# -----------------------------------------------------------------------------
# Arma Reforger default ports
GAME_PORT="2001"           # Main game port (UDP)
STEAM_QUERY_PORT="17777"   # Steam query port (UDP)
RCON_PORT="19999"          # RCON port (TCP) - if enabled

# SSH port (change if you use a non-standard port)
SSH_PORT="22"

# Your server's public interface (check with: ip a)
INTERFACE="eth0"

# Whitelist your own IPs (space-separated)
WHITELIST_IPS=""

# Maximum connections per IP for game server
GAME_CONN_LIMIT="10"

# Rate limits
SYN_RATE="50/s"
SYN_BURST="100"
UDP_RATE="100/s"
UDP_BURST="200"
ICMP_RATE="10/s"
ICMP_BURST="20"

# -----------------------------------------------------------------------------
# Flush existing rules
# -----------------------------------------------------------------------------
echo "[*] Flushing existing rules..."
iptables -F
iptables -X
iptables -t mangle -F
iptables -t mangle -X
iptables -t raw -F
iptables -t raw -X

# -----------------------------------------------------------------------------
# Default policies
# -----------------------------------------------------------------------------
echo "[*] Setting default policies..."
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# -----------------------------------------------------------------------------
# Create custom chains
# -----------------------------------------------------------------------------
echo "[*] Creating custom chains..."
iptables -N DDOS_PROTECT 2>/dev/null || iptables -F DDOS_PROTECT
iptables -N UDP_FLOOD 2>/dev/null || iptables -F UDP_FLOOD
iptables -N SYN_FLOOD 2>/dev/null || iptables -F SYN_FLOOD
iptables -N PORT_SCAN 2>/dev/null || iptables -F PORT_SCAN
iptables -N GAME_TRAFFIC 2>/dev/null || iptables -F GAME_TRAFFIC

# -----------------------------------------------------------------------------
# Loopback - Allow all
# -----------------------------------------------------------------------------
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# -----------------------------------------------------------------------------
# Whitelist IPs (bypass all filtering)
# -----------------------------------------------------------------------------
for ip in $WHITELIST_IPS; do
    echo "[*] Whitelisting IP: $ip"
    iptables -A INPUT -s "$ip" -j ACCEPT
done

# -----------------------------------------------------------------------------
# Drop invalid packets (mangle table for performance)
# -----------------------------------------------------------------------------
echo "[*] Configuring invalid packet filtering..."
iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP

# Drop packets with bogus TCP flags
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,ACK FIN -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,URG URG -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,PSH PSH -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL NONE -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL ALL -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP

# Drop fragments
iptables -t mangle -A PREROUTING -f -j DROP

# Drop XMAS packets
iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL FIN,URG,PSH -j DROP

# -----------------------------------------------------------------------------
# Block spoofed/private IPs on public interface (anti-spoofing)
# -----------------------------------------------------------------------------
echo "[*] Configuring anti-spoofing rules..."
iptables -t mangle -A PREROUTING -i $INTERFACE -s 10.0.0.0/8 -j DROP
iptables -t mangle -A PREROUTING -i $INTERFACE -s 172.16.0.0/12 -j DROP
iptables -t mangle -A PREROUTING -i $INTERFACE -s 192.168.0.0/16 -j DROP
iptables -t mangle -A PREROUTING -i $INTERFACE -s 224.0.0.0/4 -j DROP
iptables -t mangle -A PREROUTING -i $INTERFACE -s 240.0.0.0/5 -j DROP
iptables -t mangle -A PREROUTING -i $INTERFACE -s 127.0.0.0/8 -j DROP
iptables -t mangle -A PREROUTING -i $INTERFACE -s 0.0.0.0/8 -j DROP

# -----------------------------------------------------------------------------
# SYN Flood Protection
# -----------------------------------------------------------------------------
echo "[*] Configuring SYN flood protection..."
iptables -A SYN_FLOOD -m limit --limit $SYN_RATE --limit-burst $SYN_BURST -j RETURN
iptables -A SYN_FLOOD -j DROP

# Apply to new TCP connections
iptables -A INPUT -p tcp --syn -j SYN_FLOOD

# -----------------------------------------------------------------------------
# UDP Flood Protection (Critical for game servers)
# -----------------------------------------------------------------------------
echo "[*] Configuring UDP flood protection..."
iptables -A UDP_FLOOD -m limit --limit $UDP_RATE --limit-burst $UDP_BURST -j RETURN
iptables -A UDP_FLOOD -j DROP

# -----------------------------------------------------------------------------
# Port Scan Detection
# -----------------------------------------------------------------------------
echo "[*] Configuring port scan detection..."
iptables -A PORT_SCAN -m recent --name portscan --rcheck --seconds 86400 -j DROP
iptables -A PORT_SCAN -m recent --name portscan --remove
iptables -A PORT_SCAN -p tcp --tcp-flags ALL NONE -m recent --name portscan --set -j DROP
iptables -A PORT_SCAN -p tcp --tcp-flags ALL ALL -m recent --name portscan --set -j DROP

# -----------------------------------------------------------------------------
# ICMP Rate Limiting (Ping flood protection)
# -----------------------------------------------------------------------------
echo "[*] Configuring ICMP rate limiting..."
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit $ICMP_RATE --limit-burst $ICMP_BURST -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT
iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT

# -----------------------------------------------------------------------------
# Game Server Traffic Rules (Arma Reforger)
# -----------------------------------------------------------------------------
echo "[*] Configuring game server rules..."

# Game port (UDP) - with connection limit per IP
iptables -A GAME_TRAFFIC -p udp --dport $GAME_PORT -m connlimit --connlimit-above $GAME_CONN_LIMIT --connlimit-mask 32 -j DROP
iptables -A GAME_TRAFFIC -p udp --dport $GAME_PORT -m hashlimit \
    --hashlimit-name game_limit \
    --hashlimit-above 50/sec \
    --hashlimit-burst 100 \
    --hashlimit-mode srcip \
    --hashlimit-srcmask 32 \
    -j DROP
iptables -A GAME_TRAFFIC -p udp --dport $GAME_PORT -j ACCEPT

# Steam query port (UDP) - more restrictive
iptables -A GAME_TRAFFIC -p udp --dport $STEAM_QUERY_PORT -m hashlimit \
    --hashlimit-name query_limit \
    --hashlimit-above 10/sec \
    --hashlimit-burst 20 \
    --hashlimit-mode srcip \
    --hashlimit-srcmask 32 \
    -j DROP
iptables -A GAME_TRAFFIC -p udp --dport $STEAM_QUERY_PORT -j ACCEPT

# RCON port (TCP) - very restrictive
iptables -A GAME_TRAFFIC -p tcp --dport $RCON_PORT -m connlimit --connlimit-above 3 --connlimit-mask 32 -j DROP
iptables -A GAME_TRAFFIC -p tcp --dport $RCON_PORT -m hashlimit \
    --hashlimit-name rcon_limit \
    --hashlimit-above 5/sec \
    --hashlimit-burst 10 \
    --hashlimit-mode srcip \
    --hashlimit-srcmask 32 \
    -j DROP
iptables -A GAME_TRAFFIC -p tcp --dport $RCON_PORT -j ACCEPT

# Apply game traffic chain
iptables -A INPUT -j GAME_TRAFFIC

# -----------------------------------------------------------------------------
# SSH Protection
# -----------------------------------------------------------------------------
echo "[*] Configuring SSH protection..."
iptables -A INPUT -p tcp --dport $SSH_PORT -m conntrack --ctstate NEW -m recent --set --name SSH
iptables -A INPUT -p tcp --dport $SSH_PORT -m conntrack --ctstate NEW -m recent --update --seconds 60 --hitcount 4 --name SSH -j DROP
iptables -A INPUT -p tcp --dport $SSH_PORT -m conntrack --ctstate NEW -j ACCEPT

# -----------------------------------------------------------------------------
# Established/Related Connections
# -----------------------------------------------------------------------------
echo "[*] Allowing established connections..."
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# -----------------------------------------------------------------------------
# Docker bridge network (if using Docker)
# -----------------------------------------------------------------------------
echo "[*] Configuring Docker network rules..."
iptables -A INPUT -i docker0 -j ACCEPT
iptables -A INPUT -i br-+ -j ACCEPT

# -----------------------------------------------------------------------------
# Log dropped packets (optional - can be noisy under attack)
# -----------------------------------------------------------------------------
# Uncomment to enable logging:
# iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "IPTABLES_DROP: " --log-level 4

# -----------------------------------------------------------------------------
# Final DROP for anything else
# -----------------------------------------------------------------------------
iptables -A INPUT -j DROP

# -----------------------------------------------------------------------------
# Save rules
# -----------------------------------------------------------------------------
echo "[*] Saving rules..."
if command -v iptables-save &> /dev/null; then
    if [ -d /etc/iptables ]; then
        iptables-save > /etc/iptables/rules.v4
    elif [ -f /etc/sysconfig/iptables ]; then
        iptables-save > /etc/sysconfig/iptables
    else
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/rules.v4
    fi
fi

echo "[+] DDoS protection rules applied successfully!"
echo ""
echo "Active rules summary:"
iptables -L -n -v --line-numbers | head -50
